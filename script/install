#!/bin/bash

#AUTH hwding
#DATE SEP/05/2017
#DESC install unstamp as a command

user_bin=`echo ~`"/bin/"
jar_name="pdf-unstamper.jar"
exe_name="unstamp"
_version="0.1.2"
jar_durl="https://github.com/hwding/pdf-unstamper/releases/download/$_version/$jar_name"
wrapper="#!/bin/bash\njava -jar ${user_bin}${jar_name} \"\$@\"\n"

function chk_f() {
    if [ ! -f "$1" ]; then
        return 0;
    else
        return 1;
    fi
}

function chk_d() {
    if [ ! -d $1 ]; then
        return 0;
    else
        return 1;
    fi
}

echo -e "\n╭──────────────────────────────────────────────╮"
echo -e "│          Installer for pdf-unstamper         │"
echo -e "│    https://github.com/hwding/pdf-unstamper   │"
echo -e "╰──────────────────────────────────────────────╯\n"

# check JRE installation
if type -p java > /dev/null 2>&1; then
    _java=1
    echo "> JRE detected in PATH"
elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    _java=1
    echo "> JRE detected in JAVA_HOME"
else
    _java=0
    read -p "You do not have JRE installed, continue? [ENTER]"
fi

# check JRE version
if [ $_java -gt 0 ]; then
    version=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}')
    if [[ "$version" > "1.8" ]]; then
        echo "> JRE version is at least 1.8"
    else         
        read -p "> JRE version less than 1.8, continue? [ENTER]"
    fi
fi

# check ~/bin/
chk_d $user_bin
if [ $? -eq 0 ]; then
    echo "> target dir $user_bin not detected, creating..."
    `mkdir $user_bin`
else
    echo "> target dir $user_bin detected"
fi

# fetch JAR
chk_f "$jar_name"
if [ $? -eq 1 ]; then
    `rm $jar_name`
fi
echo -n "> downloading $jar_name version $_version from GitHub..."
`wget $jar_durl > /dev/null 2>&1`
echo "done"

# generate wrapper
chk_f $exe_name
if [ $? -eq 0 ]; then
    echo "> generating wrapper..."
    echo -e $wrapper > $exe_name
fi

# uninstall old version
chk_f "${user_bin}${jar_name}"
if [ $? -eq 1 ]; then
    echo "> removing old version of $jar_name"
    echo -n "> "
    `rm -i ${user_bin}${jar_name}`
fi
chk_f "${user_bin}${exe_name}"
if [ $? -eq 1 ]; then
    echo "> removing old version of $exe_name"
    echo -n "> "
    `rm -i ${user_bin}${exe_name}`
fi

# install
echo "> installing ${exe_name}..."
`mv $jar_name $user_bin`
`mv $exe_name $user_bin`

# grant permission
echo "> grant executable permission to wrapper..."
`chmod +x ${user_bin}${exe_name}`

echo "> ${exe_name} installed as ${user_bin}${exe_name}"
echo -e "> hava a nice day\n"
